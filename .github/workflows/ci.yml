name: CI

permissions:
  contents: read

env:
  VITE_FITBIT_CLIENT_ID: ${{ secrets.FITBIT_CLIENT_ID }}

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Run lint
        run: npm run lint

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Vite warnings
        run: npm run build

      - name: Check bundle size
        run: |
          echo "=== Bundle Size Check ==="
          echo "Uncompressed size:"
          du -sh dist/
          echo ""
          echo "Calculating gzipped size..."
          GZIPPED_SIZE=$(tar -czf - dist/ | wc -c)
          GZIPPED_MB=$(echo "scale=2; $GZIPPED_SIZE / 1024 / 1024" | bc)
          echo "Gzipped size: ${GZIPPED_MB}MB"
          echo ""
          # Fail if gzipped bundle exceeds 3.5MB (increased for correlation analysis pipeline)
          MAX_SIZE_MB=3.5
          if (( $(echo "$GZIPPED_MB > $MAX_SIZE_MB" | bc -l) )); then
            echo "❌ Bundle size ${GZIPPED_MB}MB exceeds maximum ${MAX_SIZE_MB}MB"
            exit 1
          else
            echo "✅ Bundle size ${GZIPPED_MB}MB is within ${MAX_SIZE_MB}MB limit"
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: dist/
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        run: |
          echo "=== Coverage Threshold Check ==="
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "❌ Coverage summary not found"
            exit 1
          fi

          # Extract line coverage percentage
          LINE_COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
          echo "Line coverage: ${LINE_COVERAGE}%"
          echo ""

          # Fail if coverage is below 75%
          MIN_COVERAGE=75
          if (( $(echo "$LINE_COVERAGE < $MIN_COVERAGE" | bc -l) )); then
            echo "❌ Coverage ${LINE_COVERAGE}% is below minimum ${MIN_COVERAGE}%"
            exit 1
          else
            echo "✅ Coverage ${LINE_COVERAGE}% meets minimum ${MIN_COVERAGE}%"
          fi

  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright E2E tests
        run: npm run test:e2e

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: |
          echo "=== Security Audit ==="
          npm audit --audit-level=moderate
          echo "✅ No moderate or high vulnerabilities found"

  ci-gate:
    name: CI Gate (All Checks Pass)
    runs-on: ubuntu-latest
    needs: [lint, build, test, e2e, security]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          if [[ "${{ needs.lint.result }}" != "success" || \
                "${{ needs.build.result }}" != "success" || \
                "${{ needs.test.result }}" != "success" || \
                "${{ needs.security.result }}" != "success" ]]; then
            echo "❌ One or more checks failed"
            exit 1
          fi
          echo "✅ All checks passed. Ready for deployment."
