name: CI

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Check formatting
        run: npm run format:check
      - name: Run lint
        run: npm run lint

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Check Vite warnings
        run: npm run build
      - name: Check bundle size
        run: |
          echo "=== Bundle Size Check ==="
          echo "Uncompressed size:"
          du -sh dist/
          echo ""
          echo "Calculating gzipped size..."
          GZIPPED_SIZE=$(tar -czf - dist/ | wc -c)
          GZIPPED_MB=$(echo "scale=2; $GZIPPED_SIZE / 1024 / 1024" | bc)
          echo "Gzipped size: ${GZIPPED_MB}MB"
          echo ""
          # Fail if gzipped bundle exceeds 2.6MB (current: ~2.5MB)
          MAX_SIZE_MB=2.6
          if (( $(echo "$GZIPPED_MB > $MAX_SIZE_MB" | bc -l) )); then
            echo "❌ Bundle size ${GZIPPED_MB}MB exceeds maximum ${MAX_SIZE_MB}MB"
            exit 1
          else
            echo "✅ Bundle size ${GZIPPED_MB}MB is within ${MAX_SIZE_MB}MB limit"
          fi

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run tests with coverage
        run: npm run test:coverage
      - name: Check coverage threshold
        run: |
          echo "=== Coverage Threshold Check ==="
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "❌ Coverage summary not found"
            exit 1
          fi

          # Extract line coverage percentage
          LINE_COVERAGE=$(node -pe "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json')).total.lines.pct")
          echo "Line coverage: ${LINE_COVERAGE}%"
          echo ""

          # Fail if coverage is below 80%
          MIN_COVERAGE=80
          if (( $(echo "$LINE_COVERAGE < $MIN_COVERAGE" | bc -l) )); then
            echo "❌ Coverage ${LINE_COVERAGE}% is below minimum ${MIN_COVERAGE}%"
            exit 1
          else
            echo "✅ Coverage ${LINE_COVERAGE}% meets minimum ${MIN_COVERAGE}%"
          fi

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run security audit
        run: |
          echo "=== Security Audit ==="
          npm audit --audit-level=moderate
          echo "✅ No moderate or high vulnerabilities found"
